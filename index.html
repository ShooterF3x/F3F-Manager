<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d6efd">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>F3F Manager v5.31</title> <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Archivo:wght@400;600;700&family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/app.js?v=orange" defer></script>
</head>
<body data-theme="cyber">

<div id="custom-modal-overlay"><div class="modal-box"><div id="modal-msg" style="margin-bottom:20px; font-weight:bold;"></div><input type="text" id="modal-input-field" class="hidden" style="margin-bottom:20px; width:100%;"><div id="modal-buttons" class="row"></div></div></div>
<input type="file" id="import-file" style="display:none" accept=".json,.bak" onchange="handleFile(this)">

<div id="view-home">
    <div style="position:absolute; top:20px; right:15px; display:flex; gap:10px;">
        <button class="btn btn-help" onclick="navigateTo('help')">?</button>
        <button class="btn btn-outline" style="width:auto; padding:10px;" onclick="navigateTo('settings')">‚öôÔ∏è</button>
    </div>
    <div class="logo-container">
        <div class="logo-main">F3F</div>
        <div class="logo-sub">MANAGER v5.31</div>
    </div>
    <div id="glider-list"></div>
    <div class="row" style="margin-top:20px;"><button class="btn btn-primary" onclick="createNewGlider()" data-i18n="new_model">NOUVEAU MOD√àLE</button></div>
    <div class="row"><button class="btn btn-log" onclick="navigateTo('logbook')" data-i18n="logbook_btn">JOURNAL DES VOLS</button></div>
    <div class="copyright">¬© 2026 F3F Manager (PWA Ready)</div>
</div>

<div id="view-help" class="hidden">
    <h1 data-i18n="help_title">AIDE</h1>
    <div class="card" id="help-content" style="text-align:left;"></div>
    <button class="btn btn-outline" onclick="history.back()" data-i18n="back">RETOUR</button>
</div>

<div id="view-settings" class="hidden">
    <h1 data-i18n="settings_title">PARAM√àTRES</h1>
    <div class="card">
        <h2 data-i18n="language">LANGUE</h2>
        <select id="lang-select" onchange="changeLang(this.value)" style="margin-bottom:20px;">
            <option value="fr">üá´üá∑ FRAN√áAIS</option>
            <option value="en">üá∫üá∏ ENGLISH</option>
            <option value="es">üá™üá∏ ESPA√ëOL</option>
        </select>
        
        <h2 data-i18n="theme">TH√àME</h2>
        <select id="theme-select" onchange="setTheme(this.value)" style="margin-bottom:20px;">
            <option value="cyber">CYBER (D√©faut)</option>
            <option value="snow">SNOW (Clair)</option>
            <option value="flat">FLAT (Design)</option>
            <option value="bunker">BUNKER (Indus)</option>
        </select>

        <h2 style="margin-top:20px;" data-i18n="opt_title">OPTIMISATION</h2>
        <div style="margin-bottom:10px; font-size:0.8rem; color:var(--text-muted);" data-i18n="opt_desc">R√©glages des limites acceptables pour l'algorithme.</div>
        <div class="row">
            <div style="flex:1"><label class="lbl-small" data-i18n="lbl_tol_w_min">Tol. Poids Moins (-g)</label><input type="number" id="set-tol-w-min" onchange="saveOptParams()"></div>
            <div style="flex:1"><label class="lbl-small" data-i18n="lbl_tol_w_max">Tol. Poids Plus (+g)</label><input type="number" id="set-tol-w-max" onchange="saveOptParams()"></div>
        </div>
        <div class="row">
            <div style="flex:1"><label class="lbl-small" data-i18n="lbl_tol_cg_plus">Tol. CG + (mm)</label><input type="number" id="set-tol-cg-plus" step="0.1" onchange="saveOptParams()"></div>
            <div style="flex:1"><label class="lbl-small" data-i18n="lbl_tol_cg_min">Tol. CG - (mm)</label><input type="number" id="set-tol-cg-minus" step="0.1" onchange="saveOptParams()"></div>
        </div>

        <h2 data-i18n="global_calc" style="margin-top:20px;">Calcul Global</h2>
        <div style="margin-bottom:10px; font-size:0.8rem; color:var(--text-muted);" data-i18n="gl_desc"> D√©finissez la courbe de ballastage. </div>
        
       <div style="background:var(--input); padding:10px; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:10px;">
            <div style="font-weight:bold; color:var(--primary); margin-bottom:5px; font-size:0.9rem;">POINT 1 (L√©ger/Vide)</div>
            <div class="row">
                <div style="flex:1"><label class="lbl-small">Vent (m/s)</label><input type="number" id="set-v1" step="1" onchange="calculateCurve()"></div>
                <div style="flex:1"><label class="lbl-small">Poids (kg)</label><input type="number" id="set-m1" step="0.01" onchange="calculateCurve()"></div>
            </div>
        </div>

        <div class="row" style="margin-bottom:10px; align-items:center; justify-content:space-between; padding:0 5px;">
            <label style="font-weight:bold; font-size:0.9rem;">Activer Double Pente</label>
            <input type="checkbox" id="check-bilinear" onclick="toggleBilinearMode()" style="width:20px; height:20px;">
        </div>

        <div id="block-pivot" class="hidden" style="background:rgba(13, 110, 253, 0.1); padding:10px; border-radius:var(--radius); border:1px solid var(--primary); margin-bottom:10px;">
            <div style="font-weight:bold; color:#fff; margin-bottom:5px; font-size:0.9rem;">üìç POINT PIVOT (Interm√©diaire)</div>
            <div class="row">
                <div style="flex:1"><label class="lbl-small">Vent (m/s)</label><input type="number" id="set-v-pivot" step="1" onchange="calculateCurve()"></div>
                <div style="flex:1"><label class="lbl-small">Poids (kg)</label><input type="number" id="set-m-pivot" step="0.01" onchange="calculateCurve()"></div>
            </div>
        </div>
        
        <div style="background:var(--input); padding:10px; border-radius:var(--radius); border:1px solid var(--border);">
            <div style="font-weight:bold; color:var(--primary); margin-bottom:5px; font-size:0.9rem;">POINT 2 (Lourd/Max)</div>
            <div class="row">
                <div style="flex:1"><label class="lbl-small">Vent (m/s)</label><input type="number" id="set-v2" step="1" onchange="calculateCurve()"></div>
                <div style="flex:1"><label class="lbl-small">Poids (kg)</label><input type="number" id="set-m2" step="0.01" onchange="calculateCurve()"></div>
            </div>
        </div>

        <div class="row" style="margin-top:15px;">
             <div style="flex:1"><label class="lbl-small" data-i18n="ref_surf">Ref. Surf (dm¬≤)</label><input type="number" id="set-ref-area" step="1" onchange="saveGlobalCoefs()"></div>
             <div style="flex:1"></div>
        </div>
        
        <div class="row" style="margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; border:1px solid var(--border);">
            <div style="flex:1; text-align:center;">
                <span class="lbl-small">COEF A</span><br>
                <span id="disp-coef-a" style="font-family:var(--font-num); font-size:1.2rem; font-weight:bold; color:var(--primary);">---</span>
            </div>
            <div style="flex:1; text-align:center;">
                <span class="lbl-small">COEF B</span><br>
                <span id="disp-coef-b" style="font-family:var(--font-num); font-size:1.2rem; font-weight:bold; color:var(--primary);">---</span>
            </div>
        </div>

        <div class="card" style="margin-top:15px; padding:10px;">
            <canvas id="settings-chart" style="height:200px; width:100%;"></canvas>
        </div>

        <h2 data-i18n="data_title" style="margin-top:20px;">DONN√âES & SAUVEGARDE</h2>
        <button class="btn btn-dark" onclick="exportData('all')" data-i18n="export_all">EXPORTER TOUT (.json)</button>
        <button class="btn btn-outline" onclick="triggerImport()" data-i18n="import_btn">IMPORTER</button>
    </div>
    <div class="copyright">¬© 2026 F3F Manager</div>
    <button class="btn btn-outline" onclick="history.back()" data-i18n="back">RETOUR</button>
</div>

<div id="view-calc" class="hidden">
    <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <button class="btn btn-outline" style="width:auto; padding:8px 15px;" onclick="history.back()" data-i18n="back">RETOUR</button>
        <button class="btn btn-outline" style="width:auto; padding:8px 15px;" onclick="editCurrentGlider()" data-i18n="config">CONFIG</button>
    </div>
    <h1 id="calc-title">...</h1>
    
    <div class="stats-bar">
        <div class="stat-group"><span class="stat-label" data-i18n="stat_target">CIBLE</span><span class="stat-val" id="res-sim-target" style="color:var(--text-muted);">0.000</span></div>
        <div class="stat-group"><span class="stat-label" data-i18n="stat_current">ACTUEL</span><span class="stat-val-hero" id="res-weight">0.000</span><span class="stat-tiny" id="res-loading">---</span></div>
        <div class="stat-group"><span class="stat-label" data-i18n="stat_cg">CG (mm)</span><div class="row" style="justify-content:center; align-items:baseline; gap:5px;"><span class="stat-val" id="res-cg">0.0</span><span id="cg-diff-display" style="font-size:0.9rem; font-weight:bold;"></span></div><span class="stat-tiny" id="res-target-cg-disp"></span></div>
    </div>
    <div class="bar-bg"><div class="bar-fill" id="bar-weight"></div></div>
    
    <div class="card dyno-card">
        <div class="row" style="margin-bottom:5px;">
            <div style="flex:1">
                <label class="dyno-label" data-i18n="wind">Vent (m/s)</label>
                <input type="number" id="inp-wind" step="0.1" oninput="syncInputs('wind', this.value)">
                <input type="range" id="rng-wind" min="0" max="25" step="0.5" oninput="syncInputs('wind', this.value)">
            </div>
            <div style="flex:1">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <label class="dyno-label" data-i18n="factor" style="margin-bottom:0;">Facteur %</label>
                    <span id="alt-hint" style="font-size:0.75rem; color:var(--primary); font-weight:bold;">0m</span>
                </div>
                <input type="number" id="inp-factor" oninput="syncInputs('factor', this.value)">
                <input type="range" id="rng-factor" min="50" max="120" step="1" oninput="syncInputs('factor', this.value)">
            </div>
        </div>
        <button class="btn btn-magic" onclick="autoFillBallast()" data-i18n="optimize">ü™Ñ OPTIMISER</button>
    </div>
    
    <div id="nose-ballast-container"></div>
    <div id="calc-list"></div>
    
    <button class="btn btn-danger-outline" onclick="confirmResetLoadout()" data-i18n="clear_all">Tout Vider</button>
    <div class="card" style="margin-top:20px;">
        <input type="text" id="inp-slope" placeholder="Pente" data-i18n-ph="ph_slope" style="margin-bottom:10px;">
        <button class="btn btn-log" onclick="openSaveLogModal()" data-i18n="save_flight">üíæ ENREGISTRER</button>
    </div>
</div>

<div id="view-edit" class="hidden">
    <h2 data-i18n="edit_title">√âDITION</h2>
    <div class="card">
        <label class="lbl-small" data-i18n="lbl_name">Nom</label><input type="text" id="edit-name">
        <div class="row" style="margin-top:10px;"><div><label class="lbl-small" data-i18n="lbl_empty_w">Poids Vide</label><input type="number" id="edit-empty-w"></div><div><label class="lbl-small" data-i18n="lbl_empty_cg">CG Vide</label><input type="number" id="edit-empty-cg"></div></div>
        <div class="row" style="margin-top:10px;"><div><label class="lbl-small" data-i18n="lbl_area">Surf. dm¬≤</label><input type="number" id="edit-area"></div><div><label class="lbl-small" data-i18n="lbl_target_cg">CG Cible</label><input type="number" id="edit-target"></div></div>
        <div style="margin-top:10px;">
             <div class="row">
                 <div style="flex:0 0 50px; display:flex; flex-direction:column; align-items:center;">
                     <label class="lbl-small" data-i18n="lbl_color">Col</label>
                     <input type="color" id="edit-nose-color" style="width:100%; height:35px; border:none; padding:0; background:none; cursor:pointer; margin-top:2px;">
                     <div onclick="resetColor('nose')" style="font-size:0.8rem; cursor:pointer; color:var(--text-muted); margin-top:4px;">‚Ü∫</div>
                 </div>
                 <div style="flex:1">
                     <label class="lbl-small" data-i18n="lbl_nose_dist">Dist. Nez</label>
                     <input type="number" id="edit-nose-dist" style="border-width:2px;">
                 </div>
             </div>
        </div>
    </div>
    <div class="section-title" data-i18n="chambers_title" style="margin-top:20px; margin-bottom:10px; font-weight:bold; color:var(--text-muted);">Chambres</div>
    <div id="edit-chambers-list"></div>
    <button class="btn btn-outline" style="border-style:dashed" onclick="addChamberLine()" data-i18n="add_chamber">+ Ajouter Chambre</button>
    <div style="margin-top:20px;">
        <button class="btn btn-success" onclick="saveGlider()" data-i18n="save">SAUVEGARDER</button>
        <button class="btn btn-info" onclick="duplicateGlider()" data-i18n="duplicate_model">DUPLIQUER</button>
        <button class="btn btn-dark" onclick="exportData('model')" data-i18n="export_model">EXPORTER MOD√àLE</button>
        <button class="btn btn-outline" onclick="history.back()" data-i18n="cancel">ANNULER</button>
        <button class="btn btn-danger-outline" onclick="confirmDeleteGlider()" data-i18n="delete_model">SUPPRIMER</button>
    </div>
</div>

<div id="view-logbook" class="hidden">
    <div class="row header-row">
        <button class="btn btn-outline small-btn" onclick="history.back()" data-i18n="back">‚¨Ö RETOUR</button>
        <div style="font-weight:bold; color:var(--text);" data-i18n="logbook_title">JOURNAL</div>
        <button class="btn btn-success small-btn" onclick="exportLogsCSV()">CSV</button>
    </div>
    <div class="row" style="margin-bottom:15px;"><select id="filter-model" onchange="renderLogs()"></select><select id="filter-slope" onchange="renderLogs()"></select></div>
    <div id="logs-container"></div>
    <div class="row"><button class="btn btn-outline" onclick="history.back()" data-i18n="back">RETOUR</button></div>
</div>

<div id="update-notification" class="hidden notification-toast">
    <span>Nouvelle version disponible !</span>
    <button onclick="window.location.reload()">INSTALLER</button>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                console.log('SW enregistr√© !');
                reg.onupdatefound = () => {
                    const newWorker = reg.installing;
                    newWorker.onstatechange = () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            document.getElementById('update-notification').classList.remove('hidden');
                        }
                    };
                };
            }).catch(err => console.log('Erreur SW :', err));
        });
    }
</script>

</body>
</html>